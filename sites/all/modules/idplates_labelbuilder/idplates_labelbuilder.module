<?php

/**
 * @file
 */

/**
 * Implements hook_menu().
 */
function idplates_labelbuilder_menu() {
  $items = array();

  $items['labelbuilder/size/%node'] = array(
    'title' => 'Label Builder',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('idplates_labelbuilder_size_form', 2),
    'access arguments' => array('access content'),
    'file' => 'includes/idplates_labelbuilder.sizes.inc',
  );

  $items['labelbuilder/layout/%commerce_product'] = array(
    'title' => 'Label Builder',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('idplates_labelbuilder_layout_form', 2),
    'access arguments' => array('access content'),
    'file' => 'includes/idplates_labelbuilder.layouts.inc',
  );

  $items['labelbuilder/customize/%taxonomy_term'] = array(
    'title' => 'Label Builder',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('idplates_labelbuilder_customize_form', 2),
    'access arguments' => array('access content'),
    'file' => 'includes/idplates_labelbuilder.customize.inc',
  );

  $items['labelbuilder/options'] = array(
    'title' => 'Label Builder',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('idplates_labelbuilder_options_form'),
    'access arguments' => array('access content'),
    'file' => 'includes/idplates_labelbuilder.options.inc',
  );

  $items['test'] = array(
    'title' => 'Label Builder',
    'page callback' => 'testy',
    'access arguments' => array('access content'),
  );

  return $items;
}

function testy() {
  $cart = commerce_order_load(1);
  $wrapper = entity_metadata_wrapper('commerce_order', $cart);
  foreach ($wrapper->commerce_line_items as $commerce_line_item) {
    $product = $commerce_line_item->commerce_product->field_numbering_barcode_options->set();
    $product = $commerce_line_item->commerce_product->field_label_color->set();
    $product = $commerce_line_item->commerce_product->field_label_text_line_1->set();
    $product = $commerce_line_item->commerce_product->field_label_text_line_2->set();
    $product = $commerce_line_item->commerce_product->field_label_text_line_3->set();
    $item = $commerce_line_item->value();

  }
  return '';
}

/**
 * Implements hook_theme().
 */
function idplates_labelbuilder_theme($existing, $type, $theme, $path) {
  return array(
    'idplates_labelbuilder_preview' => array(
      'template' => 'idplates-labelbuilder-preview',
      'path' => drupal_get_path('module', 'idplates_labelbuilder') . '/templates',
      'arguments' => array(
        'label' => NULL,
      ),
    ),
    'idplates_labelbuilder_size' => array(
      'template' => 'idplates-labelbuilder-size',
      'path' => drupal_get_path('module', 'idplates_labelbuilder') . '/templates',
      'arguments' => array(
        'path' => NULL,
        'size' => NULL,
        'attributes' => NULL,
      ),
    ),
    'idplates_labelbuilder_layout' => array(
      'template' => 'idplates-labelbuilder-layout',
      'path' => drupal_get_path('module', 'idplates_labelbuilder') . '/templates',
      'arguments' => array(
        'path' => NULL,
        'layout' => NULL,
        'attributes' => NULL,
      ),
    ),
  );
}

/**
 * Implements hook_views_api().
 */
function idplates_labelbuilder_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'idplates_labelbuilder') . '/includes/views/',
    'template path' => drupal_get_path('module', 'idplates_labelbuilder') . '/includes/views/templates',
  );
}

/**
 *
 */
function idplates_labelbuilder_get_label($size, $layout) {
  $query = db_select('field_data_field_label_size', 'b');
  $query->join('field_data_field_layout_options', 'y', 'b.entity_id = y.entity_id');
  $query
    ->condition('b.field_label_size_tid', $size)
    ->condition('y.field_layout_options_target_id', $layout)
    ->fields('b', array('entity_id'));

  $results = $query->execute()->fetchAssoc();

  return $results;
}

function idplates_labelbuilder_add_to_cart($product, $label, $uid = 0) {
  $updated_product = idplates_labelbuilder_copy_label_to_product($label, $product);
  $line_item = commerce_product_line_item_new($updated_product);
  $line_item = commerce_cart_product_add($uid, $line_item, FALSE);
  return $line_item;
}

function idplates_labelbuilder_copy_label_to_product($label, &$product) {
  $product->data['idplates_labelbuilder']['label'] = $label;
  $product_wrapper = entity_metadata_wrapper('commerce_product', $product);
  $product_wrapper->field_numbering_barcode_options->set($label->numbering);
  $product_wrapper->field_label_color->set($label->tag_color);
  $product_wrapper->field_label_text_line_1->set($label->text['text_a']['text']);
  $product_wrapper->field_label_text_line_2->set($label->text['text_b']['text']);
  $product_wrapper->field_label_text_line_3->set($label->text['text_c']['text']);
  commerce_product_save($product);
  return $product;
}

function idplates_label_builder_get_label_preview(&$form, &$form_state) {
  $form['column_right']['label_proof'] = array(
    '#type' => 'fieldset',
    '#title' => t('Label Proof'),
  );
  $form['column_right']['label_proof']['preview'] = array(
    '#type' => 'item',
    '#prefix' => '<div id="idplates-labelbuilder-preview-ajax-wrapper">',
    '#suffix' => '</div>',
    '#markup' => theme('idplates_labelbuilder_preview', array(
      'label' => $form_state['label'],
    )),
  );
  $form['column_right']['label_proof']['qty'] = array(
    '#type' => 'textfield',
    '#title' => t('Quantity'),
    '#ajax' => array(
      'callback' => 'idplates_label_builder_live_price_ajax_callback',
      'wrapper' => 'idplates-labelbuilder-live-price-ajax-wrapper',
      'method' => 'replace',
      'effect' => 'fade',
    ),
  );
  $form['column_right']['label_proof']['live_price'] = array(
    '#type' => 'item',
    '#markup' => 'live price',
  );

}

function idplates_label_builder_live_price_ajax_callback($form, $form_state) {
  return $form['column_right']['label_proof']['live_price'];
}

function idplates_label_builder_preview_ajax_callback($form, $form_state) {
  return $form['column_right']['label_proof']['preview'];
}
